<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Unparsing - Donnacha Oisín Kidney</title>
        <style>body{color:black;font-family:Garamond,Times New Roman,serif;font-size:14px;margin:0px auto 0px auto;padding-left:5px;padding-right:5px;max-width:600px}math{font-size:13px}img{max-width:600px}summary{outline:0}div#header{border-bottom:3px double black;margin-bottom:30px;padding:12px 0px 12px 0px}div#logo a{color:black;float:left;font-size:20px;text-decoration:none}div#header #navigation{text-align:right}div#header #navigation a{color:black;font-family:Garamond,Times New Roman,Serif;font-size:18px;margin-left:10px;text-decoration:none;text-transform:uppercase}div#footer{font-family:Garamond,Times New Roman,Serif;border-top:solid 2px black;color:#555;font-size:12px;margin-top:30px;padding:12px 0px 12px 0px;text-align:right}h1{font-family:Garamond,Times New Roman,Serif;font-size:22px;font-weight:normal}h2{font-family:Garamond,Times New Roman,Serif;font-size:20px;font-weight:normal}div.info{color:#555;font-size:15px;font-style:italic}span.quiet{color:#828282;font-style:italic}a{color:black;word-wrap:break-word}ul.post-list{margin-left:0px;padding-left:0px;list-style-type:none}.hidden_source{display:none}ol.serieslist{counter-reset:item;list-style-type:none;padding-left:20}ol li.serieslist:before{content:'Part ' counter(item,decimal) ':';counter-increment:item}table.sourceCode,tr.sourceCode,td.lineNumbers,td.sourceCode,table.sourceCode pre{margin:0;padding:0;border:0;vertical-align:baseline;border:none}td.lineNumbers{border-right:1px solid #AAAAAA;text-align:right;color:#AAAAAA;padding-right:5px;padding-left:5px}td.sourceCode{padding-left:5px}.sourceCode,code,pre,.Agda{font-size:11px;font-family:menlo,monospace}.sourceCode span.kw{color:#262C6A}.sourceCode span.dt{color:#476A97}.sourceCode span.dv{color:#262C6A}.sourceCode span.bn{color:#262C6A}.sourceCode span.fl{color:#262C6A}.sourceCode span.ch{color:#262C6A}.sourceCode span.st{color:#702C51}.sourceCode span.co{color:#435138}.sourceCode span.ot{color:#262C6A}.sourceCode span.al{color:red}.sourceCode span.fu{color:#000000}.sourceCode span.re{color:#000000}.sourceCode span.er{color:red}li{margin-bottom:2px}li:last-child{margin-bottom:0px}.Agda .Comment{color:#B22222}.Agda .Background{}.Agda .Markup{color:#000000}.Agda .Keyword{color:#CD6600}.Agda .String{color:#B22222}.Agda .Number{color:#A020F0}.Agda .Symbol{color:#404040}.Agda .PrimitiveType{color:#0000CD}.Agda .Pragma{color:black}.Agda .Operator{}.Agda .Bound{color:black}.Agda .Generalizable{color:black}.Agda .InductiveConstructor{color:#008B00}.Agda .CoinductiveConstructor{color:#8B7500}.Agda .Datatype{color:#0000CD}.Agda .Field{color:#EE1289}.Agda .Function{color:#0000CD}.Agda .Module{color:#A020F0}.Agda .Postulate{color:#0000CD}.Agda .Primitive{color:#0000CD}.Agda .Record{color:#0000CD}.Agda .DottedPattern{}.Agda .UnsolvedMeta{color:black;background:yellow}.Agda .UnsolvedConstraint{color:black;background:yellow}.Agda .TerminationProblem{color:black;background:#FFA07A}.Agda .IncompletePattern{color:black;background:#F5DEB3}.Agda .Error{color:red;text-decoration:underline}.Agda .TypeChecks{color:black;background:#ADD8E6}.Agda a{text-decoration:none}.Agda a[href]:hover{background-color:#B4EEB4}.sourceCode{overflow-x:auto}</style>
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Donnacha Oisín Kidney</a>
            </div>
            <div id="navigation">
                <a href="../about.html">About</a>
                <a href="../contact.html">Contact</a>
                <a href="../rss.xml">Feed</a>
            </div>
        </div>

        <div id="content">
            <h2>Unparsing</h2>

            <div class="info">
    Posted on April  1, 2017
</div>
<div class="info">
    
</div>
<div class="info">
    
        Tags: <a title="All pages tagged 'Haskell'." href="../tags/Haskell.html">Haskell</a>
    
</div>

<p>Pretty-printing expressions with minimal parenthesis is a little trickier than it looks. This algorithm is adapted from:</p>
<p><a href="https://www.cs.tufts.edu/~nr/pubs/unparse-abstract.html">Ramsey, Norman. ‘Unparsing Expressions With Prefix and Postfix Operators’. Software—Practice &amp; Experience 28, no. 12 (1998): 1327–1356.</a></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ot">{-# LANGUAGE DeriveFunctor #-}</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="kw">module</span> <span class="dt">Unparse</span> <span class="kw">where</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.Semigroup</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.Coerce</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Side</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>    <span class="ot">=</span> <span class="dt">L</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">R</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a>    <span class="kw">deriving</span> <span class="dt">Eq</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">ShowExpr</span> t e</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a>    <span class="ot">=</span> <span class="dt">Lit</span>     {<span class="ot">repr ::</span> t}</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">Prefix</span>  {<span class="ot">repr ::</span> t,<span class="ot"> op ::</span> <span class="dt">Op</span>,<span class="ot"> child ::</span> e}</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">Postfix</span> {<span class="ot">repr ::</span> t,<span class="ot"> op ::</span> <span class="dt">Op</span>,<span class="ot"> child ::</span> e}</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">Binary</span>  {<span class="ot">repr ::</span> t,<span class="ot"> op ::</span> <span class="dt">Op</span>,<span class="ot"> lchild ::</span> e,<span class="ot"> rchild ::</span> e}</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a>    <span class="kw">deriving</span> <span class="dt">Functor</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Op</span> <span class="ot">=</span> <span class="dt">Op</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true"></a>    {<span class="ot"> prec ::</span> <span class="dt">Int</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true"></a>    ,<span class="ot"> assoc ::</span> <span class="dt">Side</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true"></a>    }</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true"></a>showExpr</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true"></a><span class="ot">    ::</span> <span class="dt">Semigroup</span> t</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true"></a>    <span class="ot">=&gt;</span> (e <span class="ot">-&gt;</span> <span class="dt">ShowExpr</span> t e) <span class="ot">-&gt;</span> (t <span class="ot">-&gt;</span> t) <span class="ot">-&gt;</span> e <span class="ot">-&gt;</span> t</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true"></a>showExpr proj prns <span class="ot">=</span> go <span class="op">.</span> <span class="fu">fmap</span> proj <span class="op">.</span> proj</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true"></a>    go (<span class="dt">Lit</span> t) <span class="ot">=</span> t</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true"></a>    go (<span class="dt">Prefix</span> t o y) <span class="ot">=</span> t <span class="op">&lt;&gt;</span> ifPrns <span class="dt">R</span> o (getOp y) (go (<span class="fu">fmap</span> proj y))</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true"></a>    go (<span class="dt">Postfix</span> t o x) <span class="ot">=</span> ifPrns <span class="dt">L</span> o (getOp x) (go (<span class="fu">fmap</span> proj x)) <span class="op">&lt;&gt;</span> t</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true"></a>    go (<span class="dt">Binary</span> t o x y) <span class="ot">=</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true"></a>        ifPrns <span class="dt">L</span> o (getOp x) (go (<span class="fu">fmap</span> proj x)) <span class="op">&lt;&gt;</span> t <span class="op">&lt;&gt;</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true"></a>        ifPrns <span class="dt">R</span> o (getOp y) (go (<span class="fu">fmap</span> proj y))</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true"></a>    ifPrns sid (<span class="dt">Op</span> op oa) (<span class="dt">Just</span> (<span class="dt">Op</span> ip ia))</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true"></a>      <span class="op">|</span> ip <span class="op">&lt;</span> op <span class="op">||</span> ip <span class="op">==</span> op <span class="op">&amp;&amp;</span> (ia <span class="op">/=</span> oa <span class="op">||</span> sid <span class="op">/=</span> oa) <span class="ot">=</span> prns</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true"></a>    ifPrns _ _ _ <span class="ot">=</span> <span class="fu">id</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true"></a>    getOp <span class="dt">Lit</span>{} <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true"></a>    getOp e <span class="ot">=</span> <span class="dt">Just</span> (op e)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true"></a><span class="ot">showSExpr ::</span> (e <span class="ot">-&gt;</span> <span class="dt">ShowExpr</span> <span class="dt">ShowS</span> e) <span class="ot">-&gt;</span> e <span class="ot">-&gt;</span> <span class="dt">ShowS</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true"></a>showSExpr proj <span class="ot">=</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true"></a>    appEndo <span class="op">.</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true"></a>    showExpr</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true"></a>        (coerce proj)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true"></a>        (coerce (<span class="fu">showParen</span> <span class="dt">True</span>))</span></code></pre></div>
<p>And an example of its use:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">Expr</span> <span class="ot">=</span> <span class="dt">Number</span> <span class="dt">Integer</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>          <span class="op">|</span> <span class="dt">Expr</span> <span class="op">:+:</span> <span class="dt">Expr</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>          <span class="op">|</span> <span class="dt">Expr</span> <span class="op">:*:</span> <span class="dt">Expr</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>          <span class="op">|</span> <span class="dt">Expr</span> <span class="op">:^:</span> <span class="dt">Expr</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a><span class="kw">instance</span> <span class="dt">Num</span> <span class="dt">Expr</span> <span class="kw">where</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>  (<span class="op">+</span>) <span class="ot">=</span> (<span class="op">:+:</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>  (<span class="op">*</span>) <span class="ot">=</span> (<span class="op">:*:</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>  <span class="fu">fromInteger</span> <span class="ot">=</span> <span class="dt">Number</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>  <span class="fu">abs</span> <span class="ot">=</span> <span class="fu">undefined</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>  <span class="fu">signum</span> <span class="ot">=</span> <span class="fu">undefined</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>  <span class="fu">negate</span> <span class="ot">=</span> <span class="fu">undefined</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a><span class="co">-- | &gt;&gt;&gt; default (Expr)</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a><span class="co">-- &gt;&gt;&gt; 1 + 2 + 3</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a><span class="co">-- 1 + 2 + 3</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true"></a><span class="co">-- &gt;&gt;&gt; 1 * 2 * 3</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true"></a><span class="co">-- 1 * 2 * 3</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true"></a><span class="co">-- &gt;&gt;&gt; (1 * 2) + 3</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true"></a><span class="co">-- 1 * 2 + 3</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true"></a><span class="co">-- &gt;&gt;&gt; 1 * (2 + 3)</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true"></a><span class="co">-- 1 * (2 + 3)</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true"></a><span class="co">-- &gt;&gt;&gt; (1 :^: 2) :^: 3</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true"></a><span class="co">-- (1 ^ 2) ^ 3</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true"></a><span class="co">--</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true"></a><span class="co">-- &gt;&gt;&gt; 1 :^: (2 :^: 3)</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true"></a><span class="co">-- 1 ^ 2 ^ 3</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true"></a><span class="kw">instance</span> <span class="dt">Show</span> <span class="dt">Expr</span> <span class="kw">where</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true"></a>  <span class="fu">showsPrec</span> _ <span class="ot">=</span> showSExpr proj <span class="kw">where</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true"></a>    proj (<span class="dt">Number</span> n) <span class="ot">=</span> <span class="dt">Lit</span> (<span class="fu">shows</span> n)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true"></a>    proj (x <span class="op">:+:</span> y) <span class="ot">=</span> <span class="dt">Binary</span> (<span class="fu">showString</span> <span class="st">&quot; + &quot;</span>) (<span class="dt">Op</span> <span class="dv">3</span> <span class="dt">L</span>) x y</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true"></a>    proj (x <span class="op">:*:</span> y) <span class="ot">=</span> <span class="dt">Binary</span> (<span class="fu">showString</span> <span class="st">&quot; * &quot;</span>) (<span class="dt">Op</span> <span class="dv">4</span> <span class="dt">L</span>) x y</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true"></a>    proj (x <span class="op">:^:</span> y) <span class="ot">=</span> <span class="dt">Binary</span> (<span class="fu">showString</span> <span class="st">&quot; ^ &quot;</span>) (<span class="dt">Op</span> <span class="dv">5</span> <span class="dt">R</span>) x y</span></code></pre></div>

        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
